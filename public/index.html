<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KHAOS AI Model Intelligence Dashboard</title>
    
    <!-- Favicon links -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="header">
        <h1>üó°Ô∏è KHAOS AI Model Intelligence Dashboard</h1>
        <div class="status-indicator">
            <span id="status-dot" class="status-dot online"></span>
            <span id="status-text">Cloud Agent Online</span>
        </div>
        <div class="controls">
            <button id="refresh-btn" class="btn-secondary" onclick="dashboard.loadData()">üîÑ Refresh Data</button>
            <button id="research-btn" class="btn-primary" onclick="dashboard.triggerResearch()">üöÄ Trigger Research</button>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card khaos-card">
            <h3>ü§ñ Total Models</h3>
            <div id="total-models" class="stat-number">-</div>
        </div>
        <div class="stat-card khaos-card">
            <h3>üè¢ Providers</h3>
            <div id="total-providers" class="stat-number">-</div>
        </div>
        <div class="stat-card khaos-card">
            <h3>‚è∞ Last Update</h3>
            <div id="last-update" class="stat-number">-</div>
        </div>
        <div class="stat-card khaos-card">
            <h3>üåê Cloud Status</h3>
            <div id="cloud-status" class="stat-number success">Active</div>
        </div>
    </div>

    <div class="charts-container">
        <div class="chart-section khaos-card">
            <h2>üìä Provider Distribution</h2>
            <div id="provider-chart"></div>
        </div>
        
        <div class="chart-section khaos-card">
            <h2>üìà Model Timeline</h2>
            <div id="timeline-chart"></div>
        </div>
    </div>

    <!-- Community Ocean Section -->
    <div class="charts-container">
        <div class="chart-section khaos-card ocean-section">
            <h2>üåä Community Ocean</h2>
            <div class="ocean-stats">
                <div class="ocean-metric">
                    <div class="ocean-header">
                        <h3>HuggingFace Hub</h3>
                        <span class="ocean-badge">Community</span>
                    </div>
                    <div id="hf-total-count" class="stat-number ocean-count">50,000+</div>
                    <p class="ocean-note">Open source models from global community</p>
                </div>
            </div>
            
            <div class="ocean-context">
                <div class="context-grid">
                    <div class="context-item">
                        <strong>Scale:</strong> While enterprise providers release dozens of curated models, 
                        the community has democratized AI with tens of thousands of open contributions.
                    </div>
                    <div class="context-item">
                        <strong>Impact:</strong> This represents the largest repository of accessible AI models, 
                        from research experiments to production-ready solutions.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="models-section khaos-card">
        <h2>üóÑÔ∏è All Models</h2>
        <div class="filter-controls">
            <select id="provider-filter">
                <option value="">All Providers</option>
            </select>
            <input type="text" id="search-filter" placeholder="üîç Search models...">
        </div>
        <div id="model-grid"></div>
    </div>

    <div class="footer">
        <p>KHAOS-Researcher v2.0 | Cloud-Native Architecture | Supabase-Only | Updates every 6 hours</p>
    </div>

    <script>
        // Cloud-ready dashboard JavaScript
        class CloudDashboard {
            constructor() {
                this.apiBase = window.location.origin;
                this.modelData = null;
                this.lastUpdate = null;
                this.currentModels = [];
            }

            formatModelDate(created) {
                // Handle various timestamp formats
                if (!created || created === null || created === undefined) {
                    return 'Unknown';
                }
                
                let timestamp;
                if (typeof created === 'string') {
                    timestamp = new Date(created);
                } else if (typeof created === 'number') {
                    // Handle both seconds and milliseconds timestamps
                    timestamp = created > 1000000000000 
                        ? new Date(created)           // Already milliseconds
                        : new Date(created * 1000);   // Convert seconds to milliseconds
                } else {
                    return 'Invalid Date';
                }
                
                // Check if date is valid
                if (isNaN(timestamp.getTime())) {
                    return 'Invalid Date';
                }
                
                // Return ISO format: YYYY-MM-DD HH:MM:SS
                return timestamp.getFullYear() + '-' + 
                       String(timestamp.getMonth() + 1).padStart(2, '0') + '-' + 
                       String(timestamp.getDate()).padStart(2, '0') + ' ' +
                       String(timestamp.getHours()).padStart(2, '0') + ':' + 
                       String(timestamp.getMinutes()).padStart(2, '0') + ':' + 
                       String(timestamp.getSeconds()).padStart(2, '0');
            }

            async loadData() {
                try {
                    this.updateStatus('working', 'Loading data...');
                    
                    const response = await fetch(`${this.apiBase}/api/data`);
                    const result = await response.json();
                    
                    if (result.success) {
                        this.modelData = result.data;
                        this.currentModels = Object.values(this.modelData.models || {});
                        this.lastUpdate = new Date();
                        this.updateStatus('online', `Cloud Agent Online (${this.currentModels.length} models)`);
                        return true;
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('Failed to load data:', error);
                    this.updateStatus('error', 'Supabase Connection Required');
                    this.showSupabaseError();
                    return false;
                }
            }

            async triggerResearch() {
                try {
                    this.updateStatus('working', 'Research in Progress...');
                    
                    const response = await fetch(`${this.apiBase}/api/research`, {
                        method: 'POST'
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        this.updateStatus('online', `Research Complete: ${result.discoveries} discoveries`);
                        setTimeout(() => {
                            this.loadData().then(loaded => {
                                if (loaded) this.renderAll();
                            });
                        }, 2000); // Wait 2 seconds for data to be saved
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('Research failed:', error);
                    this.updateStatus('error', 'Research Failed');
                }
            }

            updateStatus(status, text) {
                const dot = document.getElementById('status-dot');
                const statusText = document.getElementById('status-text');
                
                dot.className = `status-dot ${status}`;
                statusText.textContent = text;
            }

            async init() {
                const loaded = await this.loadData();
                if (loaded) {
                    this.renderAll();
                } else {
                    this.showEmptyState();
                }

                // Set up auto-refresh every 5 minutes
                setInterval(() => {
                    this.loadData().then(loaded => {
                        if (loaded) this.renderAll();
                    });
                }, 5 * 60 * 1000);
            }

            renderAll() {
                if (!this.modelData) return;
                
                // Convert Supabase format to dashboard format
                this.currentModels = Object.values(this.modelData.models || {});
                
                this.updateStats();
                this.renderProviderChart();
                this.renderTimelineChart();
                this.updateFilters(); // This must come before renderModelGrid
                this.renderModelGrid();
                this.updateOceanMetrics(); // NEW: Add ocean metrics
            }

            updateStats() {
                const totalModels = this.currentModels.length;
                const providers = new Set(this.currentModels.map(m => m.provider)).size;
                const lastUpdate = this.modelData.metadata?.lastUpdate || 'Unknown';
                
                document.getElementById('total-models').textContent = totalModels.toLocaleString('de-DE');
                document.getElementById('total-providers').textContent = providers;
                
                // Fix the last update date formatting too
                if (lastUpdate !== 'Unknown') {
                    const updateDate = new Date(lastUpdate);
                    if (!isNaN(updateDate.getTime())) {
                        const formattedUpdate = updateDate.getFullYear() + '-' + 
                            String(updateDate.getMonth() + 1).padStart(2, '0') + '-' + 
                            String(updateDate.getDate()).padStart(2, '0') + ' ' +
                            String(updateDate.getHours()).padStart(2, '0') + ':' + 
                            String(updateDate.getMinutes()).padStart(2, '0') + ':' + 
                            String(updateDate.getSeconds()).padStart(2, '0');
                        document.getElementById('last-update').textContent = formattedUpdate;
                    } else {
                        document.getElementById('last-update').textContent = 'Invalid Date';
                    }
                } else {
                    document.getElementById('last-update').textContent = 'Unknown';
                }
            }

            renderProviderChart() {
                // EXCLUDE HuggingFace community-ocean from provider chart
                const enterpriseModels = this.currentModels.filter(model => 
                    !(model.provider === 'HuggingFace' && 
                      model.metadata && 
                      model.metadata.type === 'community-ocean')
                );
                
                const providers = {};
                enterpriseModels.forEach(model => {
                    providers[model.provider] = (providers[model.provider] || 0) + 1;
                });

                const data = Object.entries(providers).map(([name, value]) => ({ name, value }));
                
                // Simple bar chart with D3
                const container = document.getElementById('provider-chart');
                container.innerHTML = '';
                
                const width = 400;
                const height = 200;
                const margin = { top: 20, right: 20, bottom: 40, left: 60 };
                
                const svg = d3.select(container)
                    .append('svg')
                    .attr('width', width)
                    .attr('height', height);
                
                const x = d3.scaleBand()
                    .domain(data.map(d => d.name))
                    .range([margin.left, width - margin.right])
                    .padding(0.1);
                
                const y = d3.scaleLinear()
                    .domain([0, d3.max(data, d => d.value)])
                    .range([height - margin.bottom, margin.top]);
                
                svg.selectAll('rect')
                    .data(data)
                    .enter()
                    .append('rect')
                    .attr('class', 'chart-bar')
                    .attr('x', d => x(d.name))
                    .attr('y', d => y(d.value))
                    .attr('width', x.bandwidth())
                    .attr('height', d => y(0) - y(d.value))
                    .attr('fill', '#2F6EBA');
                
                // Add axes
                svg.append('g')
                    .attr('transform', `translate(0,${height - margin.bottom})`)
                    .call(d3.axisBottom(x));
                
                svg.append('g')
                    .attr('transform', `translate(${margin.left},0)`)
                    .call(d3.axisLeft(y));
            }

            renderTimelineChart() {
                // Simple timeline showing model creation dates
                const container = document.getElementById('timeline-chart');
                container.innerHTML = '<p>Timeline chart - showing model releases over time</p>';
            }

            renderModelGrid() {
                const grid = document.getElementById('model-grid');
                grid.innerHTML = '';
                
                // Filter out the ocean model from individual model display
                const displayModels = this.currentModels.filter(model => 
                    !(model.provider === 'HuggingFace' && 
                      model.metadata && 
                      model.metadata.type === 'community-ocean')
                );
                
                // Get current filter values
                const providerFilter = document.getElementById('provider-filter').value;
                const searchFilter = document.getElementById('search-filter').value.toLowerCase();
                
                // Filter models based on selections
                let filteredModels = displayModels;
                
                if (providerFilter) {
                    filteredModels = filteredModels.filter(model => model.provider === providerFilter);
                }
                
                if (searchFilter) {
                    filteredModels = filteredModels.filter(model => 
                        model.id.toLowerCase().includes(searchFilter) ||
                        model.provider.toLowerCase().includes(searchFilter) ||
                        (model.capabilities && model.capabilities.some(cap => 
                            cap.toLowerCase().includes(searchFilter)
                        ))
                    );
                }
                
                if (filteredModels.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-state">
                            <h3>üîç No Models Found</h3>
                            <p>Try adjusting your filters or search terms.</p>
                        </div>
                    `;
                    return;
                }
                
                filteredModels.forEach(model => {
                    const card = document.createElement('div');
                    card.className = 'model-card';
                    
                    // Use the fixed date formatting function
                    const formattedDate = this.formatModelDate(model.created);
                    
                    card.innerHTML = `
                        <h3>${model.id}</h3>
                        <p><strong>Provider:</strong> ${model.provider}</p>
                        <p><strong>Capabilities:</strong> ${(model.capabilities || []).join(', ') || 'None listed'}</p>
                        <p><strong>Created:</strong> ${formattedDate}</p>
                    `;
                    grid.appendChild(card);
                });
            }

            updateFilters() {
                const providerFilter = document.getElementById('provider-filter');
                const providers = [...new Set(this.currentModels.map(m => m.provider))].sort();
                
                // Store current selection
                const currentSelection = providerFilter.value;
                
                providerFilter.innerHTML = '<option value="">All Providers</option>';
                providers.forEach(provider => {
                    const option = document.createElement('option');
                    option.value = provider;
                    option.textContent = provider;
                    if (provider === currentSelection) {
                        option.selected = true;
                    }
                    providerFilter.appendChild(option);
                });
                
                // Add event listeners if not already added
                if (!providerFilter.hasAttribute('data-listener-added')) {
                    providerFilter.addEventListener('change', () => this.renderModelGrid());
                    providerFilter.setAttribute('data-listener-added', 'true');
                }
                
                const searchFilter = document.getElementById('search-filter');
                if (!searchFilter.hasAttribute('data-listener-added')) {
                    searchFilter.addEventListener('input', () => this.renderModelGrid());
                    searchFilter.setAttribute('data-listener-added', 'true');
                }
            }

            showEmptyState() {
                document.getElementById('model-grid').innerHTML = `
                    <div class="empty-state">
                        <h3>üîÑ Initializing KHAOS-Researcher...</h3>
                        <p>Triggering first research cycle...</p>
                        <div class="tars-insight">
                            The beauty of intelligence systems lies not in their complexity, but in their ability to make the complex simple. Let's start monitoring the AI landscape. And yes, we use proper ISO 8601 dates here - because we're scientists, not barbarians.
                        </div>
                        <button class="btn-primary" onclick="dashboard.triggerResearch()">üöÄ Start Research</button>
                    </div>
                `;
            }

            showSupabaseError() {
                document.getElementById('model-grid').innerHTML = `
                    <div class="empty-state error-bg">
                        <h3>üõ∏ Supabase Connection Required</h3>
                        <p>KHAOS-Researcher is a cloud-native system that requires database connectivity.</p>
                        <p>Please ensure Supabase is properly configured.</p>
                        <div class="tars-insight">
                            Cloud-native architecture eliminates complexity. One database, one truth. No fallbacks, no confusion.
                        </div>
                    </div>
                `;
            }

            updateOceanMetrics() {
                if (!this.modelData || !this.modelData.models) return;
                
                // Find HuggingFace ocean model
                const hfModel = Object.values(this.modelData.models)
                    .find(model => model.provider === 'HuggingFace' && model.metadata?.type === 'community-ocean');
                
                if (hfModel && hfModel.metadata && hfModel.metadata.totalModels) {
                    const count = hfModel.metadata.totalModels;
                    const countElement = document.getElementById('hf-total-count');
                    
                    if (countElement) {
                        // Show precise number with European formatting (dot for thousands)
                        countElement.textContent = count.toLocaleString('de-DE');
                    }
                }
            }
        }

        // Initialize cloud dashboard
        const dashboard = new CloudDashboard();
        window.addEventListener('DOMContentLoaded', () => {
            dashboard.init();
        });
    </script>
</body>
</html>